<!DOCTYPE html>
<html xmlns:fb="https://www.facebook.com/2008/fbml">
<html>
<head>
	<title>Like Tracker</title>
</head>
<body>
	<div id="form" class="contact-us-form">
	    <div class="title">
	        <strong>Have any questions?</strong>
	    </div>
	    <div class="subtitle">
	        <strong>Drop us a line</strong>
	    </div>
	    <form id="callus" target="_self" onsubmit="" action="javascript: postContactToGoogle()">
	        <fieldset>
	            <label for="name">What's your name? *</label>
	            <input id="name" type="text" name="name">
	        </fieldset>
	        <fieldset>
	            <label for="email">What's your email? *</label>
	            <input id="email" type="text" name="email">
	        </fieldset>
	        <fieldset>
	            <label for="feed">Questions or Feedback?*</label>
	            <textarea id="feed" name="feed"></textarea>
	        </fieldset>
	        <div style="text-align: right; padding-bottom: 15px;">* Required</div>
	        <div style="width: 100%; display: block; float: right;">
	            <button id="send" type="submit">
	                Contact Us
	            </button>
	        </div>
	        <div style="width: 100%; display: block; float: right; padding-top: 15px;">
	            <div class="requestSubmited" style="display:none; text-align: center;">Your request has been sent!</div>
	        </div>
	    </form>
	</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<script>

	var members = [];

  	window.fbAsyncInit = function() {

		FB.init({
		  appId      : '1122565244438826',
		  xfbml      : true,
		  version    : 'v2.4'
		});

		FB.login(function(response) {
		  console.log(response);

		  if (response.status=="connected") {
			console.log("You're logged in");

			for (var offset = 0; offset < 200; offset += 100) {
				var requestURL = '/600250886752341/posts?limit=100&offset=' + offset;
				console.log(requestURL);

				FB.api(requestURL, 'get', { }, function(response) {
				   console.log(response);
				   postIDs = convertJSONToArray(response);

				   // if posts not null find out who liked/commented each post
				   if (postIDs) {
				   		var postCount = postIDs.length;
				   		console.log(postCount);
				   		for (var i = 0; i < postCount; i++) {
				   			var postID = postIDs[i];
				   			getLikesOfPostWithID(postID);
				   			getCommentsOfPostWithID(postID);
				   		};
				   		
				   }

				});
			} 
			console.log(members);
			if (members)
				publish();
		  } 

		}); 
  	};

	(function(d, s, id){
		var js, fjs = d.getElementsByTagName(s)[0];
		if (d.getElementById(id)) {return;}
		js = d.createElement(s); js.id = id;
		js.src = "//connect.facebook.net/en_US/sdk.js";
		fjs.parentNode.insertBefore(js, fjs);
	}(document, 'script', 'facebook-jssdk')); 

	function convertJSONToArray(json) {
		var data = json.data;
		var count = data.length;
		var parsedData = [];
		for(var i = 0; i < count; i++) {
		    var post = data[i];
		    parsedData.push(post.id);
		}
		return parsedData;
	}



	function getLikesOfPostWithID(id) {

		FB.api(id + '/likes', 'get', { }, function(response) {
		  var peopleWhoLikeThis = response.data;
		  //console.log(peopleWhoLikeThis);
		  var peopleCount = peopleWhoLikeThis.length;
		  for (var i = 0; i < peopleCount; i++) {
		  	var userID = String(peopleWhoLikeThis[i].id);
		  	
		  	FB.api(userID, {fields: 'name'}, { }, function(response) {
		  		name = response.name;

		  		if (members[name] == undefined) {
		  			members[name] = { "likes" : 1, "comments" : 0 };
		  		} else {
		  			var numLikes = members[name]["likes"] + 1;
		  			members[name]["likes"] = numLikes;
		  		}
		  	});

		  };
		});
	}

	function getCommentsOfPostWithID(id) {

		FB.api(id + '/comments', 'get', { }, function(response) {
		  var peopleWhoCommented = response.data;
		  var peopleCount = peopleWhoCommented.length;
		  for (var i = 0; i < peopleCount; i++) {
		  	var userID = String(peopleWhoCommented[i].from.id);
		  	
		  	FB.api(userID, { }, { }, function(response) {
		  		name = response.name;

		  		if (members[name] == undefined) {
		  			members[name] = { "likes" : 0, "comments" : 1 };
		  		} else {
		  			var numComments = members[name]["comments"] + 1;
		  			members[name]["comments"] = numComments;
		  		}

		  	});
		  };

		});
	}

	function publish() {
		console.log("ajax" + members);
		$.ajax({
		         type: 'post',
		         url: 'https://script.google.com/macros/s/AKfycbzBiG7RgcSMsCUQgWRCxw8DAHbrCbawJOVfHMb-hdif8sA2zaA/exec',
		         data: members,
		         success: alert(members)
		     });
	}

	function postContactToGoogle(){
	        var name = $('#name').val();
	        var email = $('#email').val();
	        var feed = $('#feed').val();
	        if ((name !== "") && (email !== "") && (feed !== "")) {
	            $.ajax({
	                url: "https://docs.google.com/spreadsheets/d/1NswdXEilN37h1SqSWrEa5SbdkAWq1xzNaj9h9Lf3o70/pubhtml",
	                data: {"entry.1" : name, "entry.3" : email, "entry.4": feed},
	                type: "POST",
	                dataType: "xml",
	                statusCode: {
	                    0: function (){
	 
	                        $('#name').val("");
	                        $('#email').val("");
	                        $('#feed').val("");
	                        //Success message
	                    },
	                    200: function (){
	                        $('#name').val("");
	                        $('#email').val("");
	                        $('#feed').val("");
	                        //Success Message
	                    }
	                }
	            });
	        }
	        else {
	            //Error message
	        }
	    }


</script>

	<div
	  class="fb-like"
	  data-share="true"
	  data-width="450"
	  data-show-faces="true">
	</div>

</body>
</html>